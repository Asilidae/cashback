# Cashback Bank Calculator

Сервис для расчета кэшбэка по банковским выпискам (PDF-файлы). Сервис использует:

1. **FastAPI** - сервер для обработки запросов на загрузку файлов и получения расчетов.
2. **Celery** - для асинхронной обработки задач, связанных с обработкой PDF-файлов.
3. **Redis** - брокер для Celery и кэширование данных.
4. **MinIO** - S3 совместимое объектное хранилище для хранения загруженных PDF-файлов.
5. **PyMuPDF** и **pandas** - для извлечения и обработки данных из банковских выписок.

## Функциональность

1. Загрузка PDF-файлов с банковскими выписками.
2. Определение банка на основе данных из выписки.
3. Извлечение таблиц из выписок с помощью PyMuPDF.
4. Классификация транзакций по категориям.
5. Расчет кэшбэка в зависимости от условий, указанных в конфигурации.

## Параметры

1. **`config.json`**  
   Содержит параметры для извлечения табличных данных для разных банков и условия получения кэшбека.

2. **`banks_patterns.json`**  
   Содержит информацию для классификации банка выписки.

3. **`core/config.py`**  
   Содержит параметры для настройки Celery, Redis и MinIO.

4. **`partners/filter_2.xlsx`**  
   Содержит информацию о партнерах, участвующих в поиске.

## Основные модули

1. **`extract_tables.py`**  
   Извлекает таблицы из банковских выписок с использованием регулярных выражений.

2. **`transliterate_partners.py`**  
   Выполняет транслитерацию и нормализацию имен партнеров.

3. **`cashback_calculation.py`**  
   Расчет кэшбэка для каждой транзакции.

4. **`categorization.py`**  
   Классификация транзакций по категориям.

5. **`classification.py`**  
   Детекция банка по выписке.

## Эндпоинты

### 1. `/upload`

Эндпоинт для загрузки PDF-файлов.

Пример использования с `curl`:

```bash
curl -X 'POST' \
  'http://localhost:8000/upload' \
  -H 'accept: application/json' \
  -H 'Content-Type: multipart/form-data' \
  -F 'file=@ГПБ.pdf;type=application/pdf'
```
Пример ответа:
```json
{
  "task_id": "56c29e2e-6248-4572-85ac-51ae84494afe",
  "status_url": "/tasks/56c29e2e-6248-4572-85ac-51ae84494afe/status"
}
```

2. `/tasks/task_id/status`

Получение статуса обработки задачи

Пример использования с `curl`:
```bash
curl -X 'GET' \
  'http://localhost:8000/tasks/56c29e2e-6248-4572-85ac-51ae84494afe/status' \
  -H 'accept: application/json'
```
Пример ответа:
```json
{
  "status": "completed",
  "fileKey": "uploads/a473adad-a658-423b-b9d8-788751402ed7.pdf",
  "bank": "GPB",
  "dateFrom": "2024-11-30",
  "dateTo": "2025-01-25",
  "transactionsCount": 67,
  "cashbackPartners": 704,
  "cashbackNonPartners": 624
}
```

Возможные статусы задачи:
- *PENDING*: Задача в ожидании.
- *STARTED*: Задача началась.
- *SUCCESS*: Задача завершена успешно, результат доступен.
- *FAILURE*: Задача завершена с ошибкой.




